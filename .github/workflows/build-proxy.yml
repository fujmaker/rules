name: Build Proxy Rules Only
on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *" # 北京时间 06:00
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Geo Tools
        run: go install github.com/metacubex/geo/cmd/geo@master

      - name: Collect Proxy Domains
        run: |
          mkdir -p data/
          # 1. 下载 GFWList (通过转换工具)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/gfw.txt > temp-proxy.txt
          # 2. 下载 Telegram IP 范围 (域名格式)
          echo "telegram.org" >> temp-proxy.txt
          echo "t.me" >> temp-proxy.txt
          # 3. 下载常用的国外大厂规则 (Loyalsoldier 维护版)
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/domain-list-custom/release/geolocation-\!cn.txt | grep -E "^domain:|full:" | sed 's/domain://g' >> temp-proxy.txt
          # 4. 去重并清理格式
          sort -u temp-proxy.txt | sed '/^$/d' > data/proxy

      - name: Build Geosite (V2Ray .dat)
        run: |
          # 克隆工具用来压制 .dat
          git clone --depth 1 https://github.com/v2fly/domain-list-community community
          go run ./community/main.go --datapath=./data --outputname=geosite-proxy.dat

      - name: Build Proxy IP (GeoIP .dat)
        run: |
          # 获取非中国 IP 段 (即通常需要代理的国外 IP)
          wget -O geoip-proxy.dat https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat

      - name: Convert to Sing-box & Clash Binary
        run: |
          mkdir -p publish/
          # 转换域名为 Sing-box (.srs)
          geo convert site -i v2ray -o sing -f publish/proxy.srs geosite-proxy.dat
          # 转换域名为 Clash Meta (.mrs)
          geo convert site -i v2ray -o meta -f publish/proxy.mrs geosite-proxy.dat
          # 移动原始 .dat 到发布目录
          mv geosite-proxy.dat publish/
          mv geoip-proxy.dat publish/

      - name: Upload Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: publish/*
          tag: latest
          file_glob: true
          overwrite: true
          release_name: "Proxy Rules Latest"
